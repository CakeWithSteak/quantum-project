import numpy as np

from src.signal.rules import RuleSet
from src.signal.signal import SignalSimulation
from src.utils.visualize import visualize_image_animation

rule_set = RuleSet()

rule_set.add_rule("0...", [(1, "...0")], True, False)
rule_set.add_rule("1...", [(1, "...1")], True, False)

rule_set.add_rule("##0.", [(1, "##.0")], True, True)
rule_set.add_rule("##1.", [(1, "##.1")], True, True)

rule_set.add_rule("#.0.", [(1, "#0..")], True, True)
rule_set.add_rule("#.1.", [(1, "#1..")], True, True)

rule_set.add_rule("#.0#", [(1 / np.sqrt(2), "#0.#"), (1 / np.sqrt(2), "#1.#")], True, False)
rule_set.add_rule("#.1#", [(1 / np.sqrt(2), "#0.#"), (-1 / np.sqrt(2), "#1.#")], True, False)

rule_set.add_rule("1.1.", [(np.exp(1j * np.pi / 4), ".1.1")], True, False)
rule_set.add_rule("1.0.", [(1, ".0.1")], True, False)
rule_set.add_rule("0.1.", [(1, ".1.0")], True, False)
rule_set.add_rule("0.0.", [(1, ".0.0")], True, False)

rule_set.apply()

# np.set_printoptions(precision=3)
# print(rule_set.rule_data["s.s."].unitary)
# print(rule_set.rule_data["s..."].qubit_mappings)


def simulate_signal(width, height, time_steps, initial_state):
    images = []
    trails = []
    shots = []

    for current_steps in range(1):
        simulation = SignalSimulation(width, height, rule_set)
        simulation.init(initial_state)

        simulation.simulate(time_steps - 1, use_real=True)
        images.append(simulation.image())
        trails.append(simulation.signals())
        shots.append(simulation.shots)

    visualize_image_animation(images, shots, trails=trails, display_histogram=True)


# empty
# simulate_signal(8, 8, 10, "........"
#                           "........"
#                           "........"
#                           "........"
#                           "........"
#                           "........"
#                           "........"
#                           "1.......")

# H
# simulate_signal(8, 8, 8, "........"
#                          "........"
#                          "........"
#                          "...#...."
#                          "....#..."
#                          "........"
#                          "........"
#                          "1.......")

# crot
# simulate_signal(18, 18, 30, ".................."
#                             ".................."
#                             ".................."
#                             ".................."
#                             ".................."
#                             "...........#......"
#                             "..........##.#...."
#                             ".......###...#...."
#                             "......#..#.##....."
#                             "......#....#......"
#                             "....####.##......."
#                             "...#......#......."
#                             "...#......#......."
#                             "........####......"
#                             ".................."
#                             "........####......"
#                             ".........#........"
#                             "1.......1#........")

# cnot
simulate_signal(80, 80, 107, '................................................................................'
                             '................................................................................'
                             '................................................................................'
                             '................................................................................'
                             '................................................................................'
                             '................................................................................'
                             '................................................................................'
                             '................................................................................'
                             '................................................................................'
                             '................................................................................'
                             '................................................................................'
                             '................................................................................'
                             '................................................................................'
                             '................................................................................'
                             '................................................................................'
                             '................................................................................'
                             '................................................................................'
                             '................................................................................'
                             '................................................................................'
                             '................................................................................'
                             '..........................................................#.......#.............'
                             '.........................................................##.#......#............'
                             '......................................................###...#...................'
                             '.....................................................#..#.##....................'
                             '.....................................................#....#.....................'
                             '...................................................####.##......................'
                             '..................................................#......#......................'
                             '..................................................#......#......................'
                             '.......................................................####.....................'
                             '................................................................................'
                             '.......................................................####.....................'
                             '........................................................#.......................'
                             '........................................................#.......................'
                             '.............................................#..................................'
                             '............................................##.#................................'
                             '.........................................###...#................................'
                             '........................................#..#.##.................................'
                             '........................................#....#..................................'
                             '......................................####.##...................................'
                             '.....................................#......#...................................'
                             '.....................................#......#...................................'
                             '..........................................####..................................'
                             '................................................................................'
                             '..........................................####..................................'
                             '...........................................#....................................'
                             '...........................................#....................................'
                             '................................#...............................................'
                             '...............................##.#.............................................'
                             '............................###...#.............................................'
                             '...........................#..#.##..............................................'
                             '...........................#....#...............................................'
                             '.........................####.##................................................'
                             '........................#......#................................................'
                             '........................#......#................................................'
                             '.............................####...............................................'
                             '................................................................................'
                             '.............................####...............................................'
                             '..............................#.................................................'
                             '..............................#.................................................'
                             '...................#............................................................'
                             '..................##.#..........................................................'
                             '...............###...#..........................................................'
                             '..............#..#.##...........................................................'
                             '..............#....#............................................................'
                             '............####.##.............................................................'
                             '...........#......#.............................................................'
                             '...........#......#.............................................................'
                             '................####............................................................'
                             '................................................................................'
                             '................####............................................................'
                             '.................#..............................................................'
                             '.................#..............................................................'
                             '..............#.................................................................'
                             '...............#................................................................'
                             '................................................................................'
                             '....1.......1...................................................................'
                             '................................................................................'
                             '................................................................................'
                             '................................................................................'
                             '................................................................................')
